---
layout: post
title: Post 5
output:
  md_document:
    variant: markdown_github
    preserve_yaml: true
---

> In this post, I coded out the Black's Model, sometimes referred to as Black-76, is an adjustment of his earlier and more famous Black-Scholes options pricing model. Black's Model is widely used to model the commodity options pricing. In this post, I used stock data to calculate the Value at Risk with Taylor Series expansion approach for three different option combinations.

**Read in data**

``` r

df <- readxl::read_xlsx("df.xlsm", sheet = "Sheet1")

df$`Lag_NG` =c(0,df$`NG Price (Nov 21 Contract)`[-251])
df$`Normalized Price` = 3.551 * df$`NG Price (Nov 21 Contract)`/df$Lag_NG
df$`Normalized Price Change` = df$`Normalized Price` - 3.551
df$`Lag_Vol` =c(0,df$`Implied Vol`[-251])
df$`Vol change` = df$`Implied Vol` - df$Lag_Vol

```

**Black76 Pricing function**


``` r

Black_Option_Pricing <- function(option_type, f, x, t, r, v){

    # Inputs:

    # option_type = "p" (put) or "c" (call)

    # f = the current underlying forward price

    # x = the strike price

    # t = the time in years until the expiration of the option

    # v = the implied volatility for the underlying forward price

    # r = the continuously compounded risk free interest rate


    # Outputs:

    # value = price of either the call or the put

    # Delta is the partial derivative with respect to price

    # Gamma is the second partial derivative with respect to price

    # Vega is the partial derivative with respect to volatility

    # Theta is the partial derivative with respect to time

    # Rho is the partial derivative with respect to the interest rate


    d1 = (log(f/x) + (v^2/2)*t)/(v*sqrt(t))
    d2 = d1 - v*sqrt(t)

    if (option_type == "call"){
      result = exp(-r*t) * (f * pnorm(d1, 0, 1) - x * pnorm(d2, 0, 1))
      delta = exp(-r*t) * pnorm(d1, 0, 1)
      gama = exp(-r*t) * dnorm(d1, 0, 1)/(f * v * sqrt(t))
      vega = f * exp(-r*t) *  dnorm(d1, 0, 1) * sqrt(t)
      theta = -(f * exp(-r*t) *  dnorm(d1, 0, 1) * v)/(2*sqrt(t)) + r * f * exp(-r*t)* pnorm(d1,0, 1) - r * x * exp(-r*t)* pnorm(d2, 0, 1)
      rho  = -t * result

    } else if (option_type == "put"){
      result = exp(-r*t) * (-f * pnorm(-d1, 0, 1) + x * pnorm(-d2, 0, 1))
      delta = exp(-r*t) * (pnorm(d1, 0, 1) - 1)
      gama = exp(-r*t) * dnorm(d1, 0, 1)/(f * v * sqrt(t))
      vega = f * exp(-r*t) *  dnorm(d1, 0, 1) * sqrt(t)
      theta = -(f * exp(-r*t) *  dnorm(d1, 0, 1) * v)/(2*sqrt(t)) - r * f * exp(-r*t)* pnorm(-d1, 0, 1) - r * x * exp(-r*t)* pnorm(-d2, 0, 1)
      rho  = -t * result

    }

    solutions <- c(result,delta,gama,vega,theta,rho)
    names(solutions) <- c("value","delta","gama","vega","theta","tho")
    return(solutions)

}
```

**Covered call example**

Strike at $3.551

``` r

output = Black_Option_Pricing(option_type = "call", f = 3.551, x = 3.551, t = 0.265873016 , r = 0.01, v = 0.3)
output = -1 * output
df$`Total from Consolidated Greeks` = df$`Normalized Price Change`* (output[2]+1) + 0.5 * output[3] * df$`Normalized Price Change` * df$`Normalized Price Change` + output[4] * df$`Vol change`
unname(quantile(df$`Total from Consolidated Greeks`,0.05, na.rm = TRUE))

```

**Long/short straddle**

``` r

output_call = Black_Option_Pricing(option_type = "call", f = 3.551, x = 3.551, t = 0.265873016 , r = 0.01, v = 0.3)
output_put = Black_Option_Pricing(option_type = "put", f = 3.551, x = 3.551, t = 0.265873016 , r = 0.01, v = 0.3)

df$`Predicted Change in Option Value_call` = df$`Normalized Price Change`* output_call[2] + 0.5 * output_call[3] * df$`Normalized Price Change` * df$`Normalized Price Change` + output_call[4] * df$`Vol change`
df$`Predicted Change in Option Value_put` = df$`Normalized Price Change`* output_put[2] + 0.5 * output_put[3] * df$`Normalized Price Change` * df$`Normalized Price Change` + output_put[4] * df$`Vol change`


df$`Predicted Change in Option Value` = df$`Predicted Change in Option Value_call`+df$`Predicted Change in Option Value_put`
unname(quantile(df$`Predicted Change in Option Value`,0.05, na.rm = TRUE))
```

**Bull spread**

K1 = $3.234
K2 = $3.9875

``` r

output_call_long = Black_Option_Pricing(option_type = "call", f = 3.551, x = 3.234, t = 0.265873016 , r = 0.01, v = 0.3)
output_call_short = Black_Option_Pricing(option_type = "call", f = 3.551, x = 3.9875, t = 0.265873016 , r = 0.01, v = 0.3)

# Short
output_call_short = -1 * output_call_short

df$`Predicted Change in Option Value_call_long` = df$`Normalized Price Change`* output_call_long[2] + 0.5 * output_call_long[3] * df$`Normalized Price Change` * df$`Normalized Price Change` + output_call_long[4] * df$`Vol change`
df$`Predicted Change in Option Value_call_short` = df$`Normalized Price Change`* output_call_short[2] + 0.5 * output_call_short[3] * df$`Normalized Price Change` * df$`Normalized Price Change` + output_call_short[4] * df$`Vol change`


df$`Predicted Change in Option Value` = df$`Predicted Change in Option Value_call_long`+df$`Predicted Change in Option Value_call_short`
unname(quantile(df$`Predicted Change in Option Value`,0.05, na.rm = TRUE))
```
